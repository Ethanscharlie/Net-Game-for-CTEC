<html>
    <body>
		<h1>Pictionary</h1>
        <div id="MyID"></div>
        <div id="responseDiv"></div>

		<canvas id="myCanvas" width="400" height="400" style="border:1px solid #000000;"></canvas>

		<form id="guessForm">
			<input type="text" id="guess" name="guess">
			<input type="submit" value="Submit">
		</form> 

        <script>
			let userID = 0;

			let canvas = document.getElementById("myCanvas");
			let ctx = canvas.getContext("2d");

			let drawing = false;

			document.getElementById("guessForm").addEventListener("submit", (e) => {
				e.preventDefault();

				let guess = document.getElementById("guess").value;
                fetch(`/guess?guess=${guess}`)
                    .then(response => response.text())
                    .then(data => {})
                    .catch(error => console.error('Error:', error));
			});

            function sendGetRequest() {
                fetch(`/getgamedata?canvas=${canvas.toDataURL()}`)
                    .then(response => response.text())
                    .then(data => {
						let splitData = data.split("\n");

						userID = splitData[0].replace("yourID=", "");
						document.getElementById("MyID").innerText = `My ID: ${userID}`;

						let drawingPlayerID = splitData[1].replace("drawingPlayerID=", "");
						let newCanvasData = splitData[2].replace("canvas=", "");
						let word = splitData[3].replace("word=", "");

						document.getElementById('responseDiv').innerText = "";
						if (drawingPlayerID == userID) {
							document.getElementById('responseDiv').innerText = "YOU are drawing";
							document.getElementById('responseDiv').innerText += `     ${word}`;
						} else {
							document.getElementById('responseDiv').innerText = "YOU are guessing";
						}

						if (userID != drawingPlayerID) {
							let image = new Image();
							image.onload = function() {
								ctx.clearRect(0, 0, canvas.width, canvas.height);
								ctx.drawImage(image, 0, 0);
							};
							image.src = newCanvasData;
						}
                    })
                    .catch(error => console.error('Error:', error));
            }
			
			canvas.addEventListener('mousedown', (e) => {
			  drawing = true;
			  ctx.beginPath();
			  ctx.moveTo(e.offsetX, e.offsetY);
			});
		 
			canvas.addEventListener('mousemove', (e) => {
			  if (drawing) {
			    ctx.lineTo(e.offsetX, e.offsetY);
			    ctx.stroke();
			  }
			});
		 
			canvas.addEventListener('mouseup', () => {
			  drawing = false;
			  ctx.closePath();
			});
		 
			canvas.addEventListener('mouseleave', () => {
			  drawing = false;
			  ctx.closePath();
			});

			window.setInterval(function(){
				document.getElementById('MyID').innerText = `My ID: ${userID}`;
				sendGetRequest();
			}, 100);
        </script>
    </body>
</html>